name: ci-dgraph-jepsen-tests

on:
  workflow_dispatch: # allows manual trigger from GitHub UI
  schedule:
    - cron: 0 4 * * 3,6 # run twice weekly

env:
  GOPATH: /home/runner/go

permissions:
  contents: read

jobs:
  dgraph-jepsen-tests:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    timeout-minutes: 60
    steps:
      - name: Checkout dgraph repo
        uses: actions/checkout@v5
      - name: Checkout jepsen repo
        uses: actions/checkout@v5
        with:
          repository: dgraph-io/jepsen
          path: jepsen
          ref: master
      - name: Set jepsen root
        run: |
          #!/bin/bash
          cd jepsen
          JEPSEN_ROOT=$(pwd)
          echo "JEPSEN_ROOT=$JEPSEN_ROOT" >> $GITHUB_ENV
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Make dgraph linux build
        run: make install
      - name: Install docker-compose
        run: |
          # Create a wrapper script that translates docker-compose to docker compose
          sudo tee /usr/local/bin/docker-compose > /dev/null << 'EOF'
          #!/bin/bash
          exec docker compose "$@"
          EOF
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version
      - name: Start jepsen cluster
        run: |
          #!/bin/bash
          cd contrib/jepsen
          go build -v .
          ./jepsen --jepsen-root ${{ env.JEPSEN_ROOT }} --up-only
      - name: Run jepsen tests
        run: |
          #!/bin/bash
          cd contrib/jepsen
          ./jepsen --jepsen-root ${{ env.JEPSEN_ROOT }} --jaeger="" --web=false --test-all -l 300
      - name: Stop jepsen cluster
        run: |
          #!/bin/bash
          cd contrib/jepsen
          ./jepsen --jepsen-root ${{ env.JEPSEN_ROOT }} --down-only
